guidelines for web content transformation proxies 1.0 guidelines for web content transformation proxies 1.0 w3c working group note 26 october 2010 this version http www.w3.org tr 2010 note-ct-guidelines-20101026 latest version http www.w3.org tr ct-guidelines previous version http www.w3.org tr 2010 cr-ct-guidelines-20100617 editor jo rabin invited expert and before at mtld top level domain dotmobi copyright 2010 w3c mit ercim keio all rights reserved. w3c liability trademark and document use rules apply. abstract this document provides guidance to content transformation proxies as to whether and how to transform web content. content transformation proxies alter requests sent by user agents to servers and responses returned by servers so that the appearance structure or control flow of web applications are modified. content transformation proxies are mostly used to convert web sites designed for desktop computers to a form suitable for mobile devices. based on current practice and standards this document specifies mechanisms with which content transformation proxies should make their presence known to other parties present the outcome of alterations performed on http traffic and react to indications set by clients or servers to constrain these alterations. the objective is to reduce undesirable effects on web applications especially mobile-ready ones and to limit the diversity in the modes of operation of content transformation proxies while at the same time allowing proxies to alter content that would otherwise not display successfully on mobile devices. important considerations regarding the impact on security are highlighted. status of this document this section describes the status of this document at the time of its publication. other documents may supersede this document. a list of current w3c publications and the latest revision of this technical report can be found in the w3c technical reports index at http www.w3.org tr this document was developed by the mobile web best practices working group as part of the mobile web initiative. this document was expected to become a w3c recommendation and was published as a w3c candidate recommendation on 17 june 2010. as of october 2010 the mobile web best practices working group acknowledges the lack of existing implementations. nevertheless it also believes that the guidelines establish a framework acceptable by all parties involved. the mobile web best practices working group eventually resolved to discontinue the work on this document and to publish it as a working group note. the working group hopes that this note may serve as a basis for discussion and negotiation among players. other than changes to this section the document has not changed since its publication as a w3c candidate recommendation. in particular the use of normative language has been kept as-is. comments on this document may be sent to the working group s public email list public-bpwg-comments@w3.org with public archive the public public-content-transformation-conformance@w3.org mailing-list with public archive that had been created to gather implementation feedback may still be used for that purpose. the working group also invites people willing to contribute to the test case repository to let themselves known on the public-bpwg-comments@w3.org public mailing-list noting however that no further work is anticipated on that topic within the group as of october 2010. please check the test case repository for up-to-date information. publication as a working group note does not imply endorsement by the w3c membership. this is a draft document and may be updated replaced or obsoleted by other documents at any time. it is inappropriate to cite this document as other than work in progress. this document was produced by a group operating under the 5 february 2004 w3c patent policy. w3c maintains a public list of any patent disclosures made in connection with the deliverables of the group that page also includes instructions for disclosing a patent. an individual who has actual knowledge of a patent which the individual believes contains essential claim s must disclose the information in accordance with section 6 of the w3c patent policy. table of contents 1 introduction non-normative 1.1 purpose 1.2 audience 1.3 scope 1.4 principles 1.4.1 iab considerations 1.4.2 priority of intention 2 terminology normative 2.1 types of proxy 2.2 types of transformation 2.3 user interaction 3 conformance normative 3.1 classes of product 3.2 normative and informative parts 3.3 normative language for conformance requirements 3.4 transformation deployment conformance 4 behavior of components normative 4.1 proxy forwarding of request 4.1.1 applicable http methods 4.1.2 no-transform directive in request 4.1.3 treatment of requesters that are not web browsers 4.1.4 serving cached responses 4.1.5 alteration of http header field values 4.1.5.1 content tasting 4.1.5.2 avoiding request unacceptable responses 4.1.5.3 user selection of restructured experience 4.1.5.4 sequence of requests 4.1.5.5 original header fields 4.1.6 additional http header fields 4.1.6.1 proxy treatment of via header field 4.2 proxy forwarding of response to user agent 4.2.1 user preferences 4.2.2 receipt of cache-control no-transform 4.2.3 use of cache-control no-transform 4.2.4 server rejection of http request 4.2.5 receipt of vary http header field 4.2.6 link to handheld representation 4.2.7 wml content 4.2.8 proxy decision to transform 4.2.8.1 alteration of response 4.2.8.2 link rewriting 4.2.8.3 https link rewriting 5 testing normative appendices a references b conformance statement c internet content types associated with mobile content d internet content types associated with data content e doctypes associated with mobile content f uri patterns associated with mobile web sites g summary of user preference handling h example transformation interactions non-normative h.1 basic content tasting by proxy h.2 optimization based on previous server interaction h.3 optimization based on previous server interaction server has changed its operation h.4 server response indicating that this representation is intended for the target device h.5 server response indicating that another representation is intended for the target device i informative guidance for origin servers non-normative i.1 server response to proxy i.1.1 use of http 406 status i.1.2 use of http 403 status i.1.3 server origination of cache-control no-transform i.1.4 varying representations i.1.4.1 use of vary http header field i.1.4.2 indication of intended presentation media type of representation j applicability to transforming solutions which are out of scope non-normative k scope for future work non-normative k.1 powder k.2 link http header field k.3 sources of device information k.4 inter proxy communication k.5 explicit consent k.6 amendment to and refinement of http l acknowledgments non-normative 1 introduction non-normative 1.1 purpose within this document content transformation refers to the manipulation of requests to and responses from an origin server. this manipulation is carried out by proxies in order to provide a better user experience of content that would otherwise result in an unsatisfactory experience on the device making the request. the w3c mobile web best practices working group neither approves nor disapproves of content transformation but recognizes that is being deployed widely across mobile data access networks. the deployments are widely divergent to each other with many non-standard http implications and no well-understood means either of identifying the presence of such transforming proxies nor of controlling their actions. this document establishes a framework to allow that to happen. the overall objective of this document is to provide a means as far as is practical for users to be provided with at least a functional user experience device independence glossary of the web when mobile taking into account the fact that an increasing number of content providers create experiences specially tailored to the mobile context which they do not wish to be altered by third parties. equally it takes into account the fact that there remain a very large number of web sites that do not provide a functional user experience when perceived on many mobile devices. it is stressed that this document is unlikely to be the last word on this topic. as noted below 1.3 scope it is out of scope of this document to provide a comprehensive solution to control of transforming proxies though such a solution would appear to be needed. the document is an attempt to improve a situation at a point in time where there appears to be disregard of the provisions of http and is primarily a reminder and an encouragement to follow those provisions more closely. 1.2 audience the audience for this document is creators of content transformation proxies and purchasers and operators of such proxies. the document also contains non-normative guidance for content providers whose services may be accessed by means of such proxies. 1.3 scope the recommendations in this document refer only to web browsing i.e. access by user agents that are intended primarily for interaction by users with html web pages web browsers using http. clients that interact with proxies using mechanisms other than http and that typically involve the download of a special client are out of scope and are considered to be a distributed user agent. proxies which are operated in the control of or under the direction of the operator of an origin server are similarly considered to be a distributed origin server and hence out of scope. the w3c mobile web best practices working group bpwg is not chartered to create new technology its role is to advise on best practice for use of existing technology. in satisfying content transformation requirements existing http header fields directives and behaviors must be respected and as far as is practical no extensions to rfc 2616 http are to be used. the recommendations in this document refer to interactions of a proxy and do not refer to any presumed aspects of the internal operation of the proxy. for this reason the document does not discuss use of allow and disallow lists though it does discuss behavior that is induced by the implementation of such lists in addition it does not discuss details of how transformation is carried out except if this is reflected in interoperability. for this reason it does not discuss the insertion or insertion of headers and footers or any other specific behaviors though it does discuss the need for essential user interaction of some form moral legal and other similar questions are not in scope of this document. the bpwg does not have authority or expertise to comment one way or another about setting precedent or authorising any particular behavior or its absence. 1.4 principles 1.4.1 iab considerations the bpwg made reference to internet architecture board iab work on open pluggable edge services rfc 3238 opes for various principles that underlie behavior of proxies. in this work the iab expressed its concerns about privacy control monitoring and accountability of such services. 1.4.2 priority of intention the web allows users considerable flexibility in respect of the representation of content. at the same time content providers may have a preferred manner in which they wish their content to be represented. content transformation must reconcile these contrasting factors. in creating this recommendation the bpwg has determined that content transformation proxies should respect content providers intentions where they are expressed but may allow users to choose other representations except where content providers specifically prohibit this. the bpwg recognizes that there is neither a systematic vocabulary for content provider intentions nor a systematic means of expression of such intentions. there is scope for further work in this area see k scope for future work 2 terminology normative 2.1 types of proxy alteration of http requests and responses is not prohibited by http other than in the circumstances referred to in rfc 2616 http section 13.5.2 and section 14.9.5. http defines two types of proxy transparent proxies and non-transparent proxies. as discussed in rfc 2616 http section 1.3 terminology a transparent proxy is a proxy that does not modify the request or response beyond what is required for proxy authentication and identification. a non-transparent proxy is a proxy that modifies the request or response in order to provide some added service to the user agent such as group annotation services media type transformation protocol reduction or anonymity filtering. except where either transparent or non-transparent behavior is explicitly stated the http proxy requirements apply to both types of proxies. this document elaborates the behavior of non-transparent proxies when used for content transformation in the context discussed in ct landscape 2.2 types of transformation transforming proxies can carry out a wide variety of operations. in this document we categorize these operations as follows noting that these are general concepts that we do not formalize further alteration of requests transforming proxies process requests in a number of ways especially replacement of various request header fields to avoid http 406 status responses if a server can not provide content that is compatible with the original http request header fields and at user request. alteration of responses there are three classes of operation on responses restructuring content restructuring content is a process whereby the original layout is altered so that content is added or removed or where the spatial or navigational relationship of parts of content is altered e.g. linearization i.e. reordering presentation elements especially tables so that they fit on a narrow display and can be traversed without horizontal scrolling or pagination i.e. splitting a document too large to be stored in or transmitted to the terminal in one piece so that it can be nevertheless accessed by browsing through a succession of smaller interlinked documents it also includes rewriting uris so that subsequent requests are routed via the proxy handling the response. recoding content recoding content is a process whereby the layout of the content remains the same but details of its encoding may be altered. examples include re-encoding html as xhtml correcting invalid markup in html conversion of images between formats but not for example reducing animations to static images optimizing content optimizing content includes removing redundant white space re-compressing images without loss of fidelity and compressing for transfer. 2.3 user interaction at various points in this document there is reference to notifying the user informing the user in general making the user aware that a situation exists or interacting with the user to solicit a choice of options. the expectation is that such user interaction is conducted in a way that allows the user to perceive and interact with such information or choices in the same way as they interact with the web sites that they are visiting. 3 conformance normative 3.1 classes of product the content transformation guidelines specification has one class of products transformation deployment a transformation deployment is the provision of non-transparent components in the path of http requests and responses. provisions that are applicable to a transformation deployment are identified in this document by use of the term transforming proxy or proxy in the singular or plural. 3.2 normative and informative parts normative parts of this document are identified by the use of normative following the section name. informative parts are identified by use of non-normative following the section name. 3.3 normative language for conformance requirements the key words must must not required shall shall not should should not recommended not recommended may and optional in this recommendation have the meaning defined in rfc 2119 3.4 transformation deployment conformance a transformation deployment conforms to these guidelines if it follows the statements in 3.4 transformation deployment conformance 4.1 proxy forwarding of request 4.2 proxy forwarding of response to user agent and 5 testing normative a transformation deployment that wishes to claim conformance must make available a conformance statement b conformance statement that specifies the reasons for non-compliance with any clauses containing the key words should and should not recommended and not recommended conformance statements must be sent to public-content-transformation-conformance@w3.org. public archive of this list may be found at http lists.w3.org archives public public-content-transformation-conformance 4 behavior of components normative 4.1 proxy forwarding of request 4.1.1 applicable http methods user agents sometimes issue http head requests in order to determine if a resource is of a type and or size that they are capable of handling. a transforming proxy may convert a head request into a get request in order to determine the characteristics of a transformed response that it would return if the user agent subsequently issued a get request for the same resource if the http method is altered from head to get proxies should providing such action is in accordance with normal http caching rules cache the response so that a second get request for the same content is not required see also 4.1.4 serving cached responses other than to convert between head and get proxies must not alter request methods. 4.1.2 no-transform directive in request if the request contains a cache-control no-transform directive proxies must not alter the request other than to comply with transparent http behavior defined in rfc 2616 http sections section 14.9.5 and section 13.5.2 and to add header fields as described in 4.1.6 additional http header fields below. note an example of the use of cache-control no-transform is the issuing of asynchronous http requests perhaps by means of xmlhttprequest xhr which may include such a directive in order to prevent transformation of both the request and the response. 4.1.3 treatment of requesters that are not web browsers before altering aspects of http requests and responses proxies need to take account of the fact that http is used as a transport mechanism for many applications other than traditional browsing increasingly browser based applications involve exchanges of data using xmlhttprequest see 4.2.8 proxy decision to transform and alteration of such exchanges is likely to cause misoperation. 4.1.4 serving cached responses aside from the usual caching procedures defined in rfc 2616 http in some circumstances proxies may paginate responses and where this is the case a request may be for a subsequent page of a previously requested resource. in this case proxies may for the sake of consistency of representation serve stale data but when doing so should notify the user that this is the case and must provide a simple means of retrieving a fresh copy. 4.1.5 alteration of http header field values other than the modifications required by rfc 2616 http proxies should not modify the values of header fields other than the user-agent accept accept-charset accept-encoding and accept-language header fields and must not delete header fields see 4.1.5.5 original header fields other than to comply with transparent http operation proxies should not modify any request header fields unless one of the following applies the user would be prohibited from accessing content as a result of the server responding that the request is unacceptable see 4.2.4 server rejection of http request the user has specifically requested a restructured desktop experience see 4.1.5.3 user selection of restructured experience the request is part of a sequence of requests comprising either included resources or linked resources on the same web site see 4.1.5.4 sequence of requests these circumstances are detailed in the following sections. note it is emphasized that requests must not be altered in the presence of cache-control no-transform as described under 4.1.2 no-transform directive in request. note in this section the concept of web site is used rather than origin server as some origin servers host many different web sites. since the concept of web site is not strictly defined proxies should use heuristics including comparisons of domain name to assess whether resources form part of the same web site note the uri referred to in the request plays no part in determining whether or not to alter http request header field values. in particular the patterns mentioned in 4.2.8 proxy decision to transform are not material. 4.1.5.1 content tasting while complying with this section 4.1.5 alteration of http header field values and section 4.2.5 receipt of vary http header field proxies should avoid making repeated requests for the same resource. note while http does not prohibit repetition of get requests repeated requests place an unnecessary load on the network and server. 4.1.5.2 avoiding request unacceptable responses a proxy may reissue a request with altered http header field values if a previous request with unaltered values resulted in the origin server rejecting the request as unacceptable see 4.2.4 server rejection of http request a proxy may apply heuristics of various kinds to assess in advance of sending unaltered header field values whether the request is likely to cause a request unacceptable response. if it determines that this is likely then it may alter header field values without sending unaltered values in advance providing that it subsequently assesses the response as described under 4.2.5 receipt of vary http header field below and is prepared to reissue the request with unaltered header fields and alter its subsequent behavior in respect of the web site so that unaltered header fields are sent. a proxy must not reissue a post request as it is unsafe see rfc 2616 http section 9.1.1 4.1.5.3 user selection of restructured experience proxies must assume that by default users will wish to receive a representation prepared by the web site. proxies may offer users an option to choose to view a restructured experience even when a web site offers a choice of user experience. if a user has made such a choice then proxies may alter header field values when requesting resources in order to reflect that choice but must on receipt of an indication from a web site that it offers alternative representations see i.1.4.2 indication of intended presentation media type of representation inform the user of that and allow them to select an alternative representation. proxies must assess whether a user s expressed preference for a restructured representation is still valid if a web site changes its choice of representations see 4.2.5 receipt of vary http header field 4.1.5.4 sequence of requests when requesting resources that are included resources e.g. style sheets images proxies should make the request for such resources with the same user-agent header field as the request for the resource from which they are referenced. for the purpose of consistency of representation proxies may request linked resources e.g. those referenced using the a element that form part of the same web site as a previously requested resource with the same header fields as the resource from which they are referenced. when requesting linked resources that do not form part of the same web site as the resource from which they are linked proxies should not base their choice of header fields on a consistency of presentation premise. 4.1.5.5 original header fields when forwarding an http request with altered http header fields in addition to complying with the rules of normal http operation proxies must include in the request additional fields of the form x-device- original header name whose values are verbatim copies of the corresponding unaltered header field values so that it is possible to reconstruct the original header fields. for example if the user-agent header field has been altered an x-device-user-agent header field would be added with the value of the received user-agent header field. specifically the following mapping must be used original replacement ref user-agent x-device-user-agent rfc2616 section 14.43 accept x-device-accept rfc2616 section 14.1 accept-charset x-device-accept-charset rfc2616 section 14.2 accept-encoding x-device-accept-encoding rfc2616 section 14.3 accept-language x-device-accept-language rfc2616 section 14.4 note the x-device- prefixed header names listed in this section have been provisionally registered with iana see provisional message header field names note the x-device- prefix was chosen primarily on the basis that this is an already existing convention. it is noted that the values encoded in such header fields may not ultimately derive from a device they are merely received fields. the treatment of received x-device header fields which may happen where there are multiple transforming proxies is undefined see k scope for future work 4.1.6 additional http header fields irrespective of the presence of a no-transform directive proxies should add the ip address of the initiator of the request to the end of a comma separated list in an x-forwarded-for http header field proxies must in accordance with rfc 2616 include a via http header field see 4.1.6.1 proxy treatment of via header field 4.1.6.1 proxy treatment of via header field proxies should indicate their ability to transform content by including a comment in the via http header field consisting of the uri http www.w3.org ns ct when forwarding via header fields proxies should not alter them by removing comments from them. note according to rfc 2616 http section 14.45 via header field comments may be removed by any recipient prior to forwarding the message however the justification for removing such comments is based on memory limitations of early proxies. most modern proxies do not suffer such limitations. 4.2 proxy forwarding of response to user agent in the following proxies must check for the presence of equivalent meta http-equiv elements in html content if the relevant http header field is not present. 4.2.1 user preferences proxies must provide a means for users to express preferences for inhibiting content transformation even when content transformation has been chosen by the user as the default behavior. those preferences must be maintained on a user by user and web site by web site basis. proxies must solicit re-expression of preferences in respect of a server if the server starts to indicate that it offers varying responses as discussed under 4.2.5 receipt of vary http header field. 4.2.2 receipt of cache-control no-transform if the response includes a cache-control no-transform directive then proxies must not alter it other than to comply with transparent http behavior as described in rfc 2616 http section 13.5.2 and section 14.9.5. 4.2.3 use of cache-control no-transform proxies may use cache-control no-transform to inhibit transformation by further proxies. 4.2.4 server rejection of http request proxies may treat responses with an http 200 status as though they were responses with an http 406 status if it has determined that the content e.g. your browser is not supported is equivalent to a response with an http 406 status. 4.2.5 receipt of vary http header field a proxy may not be carrying out content tasting as described under 4.1.5.2 avoiding request unacceptable responses if it anticipates receiving a request unacceptable response. however if it makes a request with altered header fields in these circumstances and receives a response containing a vary header field referring to one of the altered header fields then it should request the resource again with unaltered header fields. it should also update whatever heuristics it uses so that unaltered header fields are presented first in subsequent requests for this resource. 4.2.6 link to handheld representation if the response is an html response and it contains a link rel alternate media handheld element and the user agent is determined as being handheld a proxy should request and process the referenced resource unless the resource referenced is the current representation. note in this document the term current representation means a same document reference as defined in rfc 3986 section 4.4 with the addition that if a vary http header field was present on the response then it is the same representation if the values of the http header fields of the request have not been altered. 4.2.7 wml content if the content is wml proxies should act in a transparent manner. note this does not affect the operation of proxies that are also wap gateways. 4.2.8 proxy decision to transform in the absence of a vary or no-transform directive or a meta http-equiv element containing cache-control no-transform proxies should not transform content matching any of the following rules unless the user has specifically requested transformation the content is html and contains link rel alternate media handheld with a reference to the current representation the doctype of the content if it has one indicates xhtml-mp xhtml basic wml or imode as listed in e doctypes associated with mobile content the content-type has a value listed in c internet content types associated with mobile content. the uri of the response following redirection or as indicated by the content-location http header field matches a pattern listed in f uri patterns associated with mobile web sites the response contains a resource that is referenced as an included resource suitable for handheld in a resource that was itself handled transparently the content-type indicates that the content is data some values are listed in d internet content types associated with data content a claim of mobileok basic mobileok basic tests conformance is indicated see mobileok scheme for how such a claim may be indicated other factors that a proxy may take into account the web site see note has previously shown that it is contextually aware even if the present response does not indicate this the user agent has features such as linearization or zoom or is a desktop device using a mobile network for access that allow it to present the content unaltered the response contains client side scripts that may misoperate if the resource is restructured the response is an html response and it includes link elements specifying alternatives according to presentation media type. 4.2.8.1 alteration of response note other than as noted in this section the nature of restructuring that is carried out any character encoding alterations and what is omitted and what is inserted is as discussed in 1.3 scope out of scope of this document. if a proxy alters the response then it must add a warning 214 transformation applied http header field the altered content should validate according to an appropriate published formal grammar and if xml must be well-formed it should indicate to the user that the content has been transformed for mobile presentation and provide an option to view the original unmodified content. 4.2.8.2 link rewriting note in this document two uris have the same-origin if the scheme component and the host and port subcomponents as defined in rfc 3986 all match. section 6 of rfc 3986 discusses uri comparison. some proxy deployments have to rewrite links in content in order for the user agent to request the referenced resources through the proxy. in so doing proxies make unrelated resources appear as though they have the same-origin and hence there is a danger of introducing security vulnerabilities. note this section on link rewriting refers also to insertion of links frame flattening and any other techniques that introduces the same-origin issue. note link rewriting is always used by ct proxies that are accessed as an origin server initially e.g. which provide mobile adapted web search and navigation to the web pages returned in the search results or to which the browser is redirected through the ct proxy for adaptation of a web page. link rewriting may be used by ct proxies acting as normal http proxies e.g. configured or transparent for the browser but may not be required since all browser requests flow through the ct proxy. proxies must not rewrite links when content transformation is prohibited. proxies must preserve security between requests for domains that are not same-origin in respect of cookies and scripts. 4.2.8.3 https link rewriting note for clarity it is emphasized that it is not possible for a transforming proxy to transform content accessed via an https link without breaking end-to-end security. interception of https and the circumstances in which it might be permissible is not a mobile question as such but is highly pertinent to this document. the bpwg is aware that interception of https happens in many networks today. interception of https is inherently problematic and may be unsafe. the bpwg would like to refer to protocol based two party consent mechanisms but such mechanisms do not exist at the time of writing of this document. the practice of intercepting https links is strongly not recommended. if a proxy rewrites https links it must advise the user of the security implications of doing so and must provide the option to bypass it and to communicate with the server directly. notwithstanding anything else in this document proxies must not rewrite https links in the presence of a cache-control no-transform directive. if a proxy rewrites https links replacement links must have the scheme https. when forwarding requests originating from https links proxies must include a via header field as discussed under 4.1.6.1 proxy treatment of via header field. when forwarding responses from servers proxies must notify the user of invalid server certificates. 5 testing normative operators of content transformation proxies should make available an interface through which the functions of the proxy can be exercised. the operations possible through this interface must cover those necessary to settle the outcome of all conformance statements listed in section b. the interface must be reachable from terminals with browsing capabilities connected to the web via a conventional internet access environment at the tester s premises accessing the interface may necessitate adjusting standard web browsing configuration parameters such as specifying a proxy ip address and port on a desktop browser or activating a wap setting on a mobile browser. such access must be granted under fair reasonable and non-discriminatory conditions. in particular it is available to all worldwide whether or not they are w3c members it does not impose any further conditions or restrictions on the use of any technology intellectual property rights or other restrictions on behaviour of the tester but may include reasonable customary terms relating to operation or maintenance of the relationship between tester and proxy operator such as the following choice of law and dispute resolution confidentiality of parameters to access the interface disclaimer of liability. a references ct landscape content transformation landscape 1.0 jo rabin andrew swainston eds w3c working group note 27 october 2009 see http www.w3.org tr 2009 note-ct-landscape-20091027 rfc 2119 key words for use in rfcs to indicate requirement levels request for comments 2119 s. bradner march 1997 see http www.ietf.org rfc rfc2119.txt rfc 2616 http hypertext transfer protocol http 1.1 request for comments 2616 r. fielding j. gettys j. mogul h. frystyk l. masinter p. leach t. berners-lee june 1999 see http tools.ietf.org html rfc2616 rfc 3986 uniform resource identifier uri generic syntax request for comments 3986 t. berners-lee r. fielding l. masinter january 2005 see http tools.ietf.org html rfc3986 rfc 3238 opes iab architectural and policy considerations for open pluggable edge services request for comments 3238 s. floyd l. daigle january 2002 see http tools.ietf.org html rfc3238 device independence glossary w3c glossary of terms for device independence rhys lewis ed w3c working draft 18 january 2005 best practices mobile web best practices 1.0 basic guidelines jo rabin charles mccathienevile eds w3c recommendation 29 july 2008 see http www.w3.org tr 2008 rec-mobile-bp-20080729 mobileok basic tests w3c mobileok basic tests 1.0 sean owen jo rabin eds w3c recommendation 08 december 2008 see http www.w3.org tr 2008 rec-mobileok-basic10-tests-20081208 mobileok scheme w3c mobileok scheme 1.0 jo rabin phil archer eds w3c note 25 august 2009 see http www.w3.org tr 2009 note-mobileok-20090825 powder resource grouping protocol for web description resources powder grouping of resources phil archer andrea perego kevin smith eds w3c recommendation 1 september 2009 see http www.w3.org tr 2009 rec-powder-grouping-20090901 xhr xmlhttprequest anne van kesteren ed w3c candidate recommendation 3 august 2010 see http www.w3.org tr 2010 cr-xmlhttprequest-20100803 xml extensible markup language xml 1.0 fifth edition t. bray j. paoli c. sperberg-mcqueen e. maler f. yergeau eds w3c recommendation 26 november 2008. see http www.w3.org tr 2008 rec-xml-20081126 b conformance statement see http www.w3.org tr 2010 note-ct-guidelines-20101026 ics c internet content types associated with mobile content this list is not exhaustive and is likely to change. application vnd.wap.xhtml+xml text vnd.wap.wml application vnd.wap.wmlc text vnd.wap.wml+xml text vnd.wap.wmlscript application vnd.wap.wmlscriptc image vnd.wap.wbmp application vnd.wap.wbxml application vnd.wap.multipart.mixed application vnd.wap.multipart.related application vnd.wap.multipart.alternative application vnd.wap.multipart.form-data image x-up-wpng image x-up-bmp d internet content types associated with data content this list is not exhaustive and is likely to change. application json application soap+xml application soap+fastinfoset application fastsoap application fastinfoset e doctypes associated with mobile content this list is not exhaustive and is likely to change. oma dtd xhtml mobile 1.2 en wapforum dtd xhtml mobile 1.1 en wapforum dtd xhtml mobile 1.0 en w3c dtd xhtml basic 1.1 en w3c dtd xhtml basic 1.0 en openwave dtd xhtml 1.0 en openwave dtd xhtml mobile 1.0 en i-mode group ja dtd xhtml i-xhtml locale ver. ja 1.0 1.0 en i-mode group ja dtd xhtml i-xhtml locale ver. ja 1.1 1.0 en i-mode group ja dtd xhtml i-xhtml locale ver. ja 2.0 1.0 en i-mode group ja dtd xhtml i-xhtml locale ver. ja 2.1 1.0 en i-mode group ja dtd xhtml i-xhtml locale ver. ja 2.2 1.0 en i-mode group ja dtd xhtml i-xhtml locale ver. ja 2.3 1.0 en w3c dtd compact html 1.0 draft en bbsw dtd compact html 2.0 en wapforum dtd wml 1.0 en wapforum dtd wml 1.1 en wapforum dtd wml 1.2 en wapforum dtd wml 1.3 en wapforum dtd wml 2.0 en phone.com dtd wml 1.1 en openwave.com dtd wml 1.3 en f uri patterns associated with mobile web sites using the notation defined in powder resource grouping iriset includehosts mobi includehosts iriset g summary of user preference handling user expression of preferences is referred to in several sections in this document. those sections are 1.4.2 priority of intention 4.1.4 serving cached responses 4.1.5.3 user selection of restructured experience 4.2.1 user preferences 4.2.2 receipt of cache-control no-transform 4.2.8 proxy decision to transform 4.2.8.1 alteration of response 4.2.8.3 https link rewriting user preferences are also referred to non-normatively under i.1.4 varying representations. h example transformation interactions non-normative note the following examples refer to requests with the get method. h.1 basic content tasting by proxy request resource with original header fields if the response is a 406 response if the response contains cache-control no-transform forward it otherwise request again with altered header fields if the response is a 200 response if the response contains vary user-agent an appropriate link element or header field or cache-control no-transform forward it otherwise assess whether the 200 response is a form of request unacceptable if it is not forward it if it is request again with altered header fields h.2 optimization based on previous server interaction proxy receives a request for resource p that it has not encountered before proxy forwards this request response is 200 ok containing the text unsupported browser. please get a different one or use a ct proxy. proxy determines that this equates to a 406 status and requests the resource from the origin server again with altered header fields emulating a well known desktop browser response is a desktop oriented representation of the resource proxy transforms this response into content that the user agent can display well and forwards it proxy receives a further request for the resource p based on evidence from the previous interaction e.g. that there was no vary header field that the response was not targeted at only the previous user in that there was no cache-control private directive the ct proxy forwards the request with altered header fields response is a desktop oriented representation of the resource proxy transforms this response into content that the user agent can display well and forwards it h.3 optimization based on previous server interaction server has changed its operation proxy receives a request for resource p that it has previously encountered as in h.2 optimization based on previous server interaction proxy forwards request with altered header fields response is 200 ok containing a vary user-agent header field proxy notices that behavior has changed and reissues the request with original header fields response is 200 ok and proxy forwards it h.4 server response indicating that this representation is intended for the target device proxy receives a request for resource p proxy forwards request with original header fields response is 200 ok with vary user-agent and link type alternate media handheld href p#id where id is a document local reference proxy forwards response as designed specifically for the requesting device h.5 server response indicating that another representation is intended for the target device proxy receives a request for resource p proxy forwards request with original header fields response is 200 ok with link type alternate media handheld href q and q is not p proxy requests q with original header fields response is 200 ok and proxy forwards it i informative guidance for origin servers non-normative content providers may wish to follow these procedures in order to improve interoperability. i.1 server response to proxy i.1.1 use of http 406 status servers should consider using an http 406 status and not an http 200 status if a request cannot be satisfied with content that meets the criteria specified by values of the http request header fields. however some browsers do not display the content of http 406 status responses. i.1.2 use of http 403 status servers should consider using an http 403 status if concerned that the security of a link assumed to be private has been compromised for example this may be inferred by the presence of a via http header field in an https request i.1.3 server origination of cache-control no-transform servers should consider including a cache-control no-transform directive if one is received in the http request as it may be an indication that the client does not wish to receive a transformed response. include a cache-control no-transform directive if for any reason transformation of the response is prohibited. note including a cache-control no-transform directive can disrupt the behavior of wap gateways because it can inhibit such proxies from converting wml to wmlc. including such a directive may also disrupt the behavior of a proxy based accessibility solution. i.1.4 varying representations it is good practice to take account of user agent capabilities and formulate an appropriate experience according to those capabilities. it is good practice to provide a means for users to select among available representations to default to the last selected representation and to provide a means of changing the selection. i.1.4.1 use of vary http header field if a server varies its representation according to examination of received http header fields then rfc 2616 http describes how to use the vary header field to indicate this. servers that are aware of the presence of a transforming proxy as identified by a via http header field might alter their responses according to their knowledge of specific proxy behavior. when doing so it is good practice to make sure that the internet content type for a response is correct for the actual content e.g. a server should not choose content-type application vnd.wap.xhtml+xml because it suspects that proxies will not transform content of this type if its content is not valid xhtml-mp i.1.4.2 indication of intended presentation media type of representation if a server has distinct representations that vary according to the target presentation media type it can inhibit transformation of the response by including a cache-control no-transform directive see i.1.3 server origination of cache-control no-transform in addition in html content it can indicate the medium for which the representation is intended by including a link element identifying in its media attribute the target presentation media types of this representation and setting the href attribute to same-document reference see rfc 3986 section 4.4 and in particular an empty href attribute is a same document reference in addition it is good practice to include link elements identifying the target presentation media types of other available representations in a similar manner. if content for more than one presentation media type is served from the same uri it is better not to use a link element identifying the presentation media types as the uri will appear to be a same document reference indicating to a client that this representation is suitable for all the named presentation media types. instead use a vary http header field indicating that the response varies according to the received user-agent http header field. note some examples of the use of the link element are included above in h example transformation interactions. j applicability to transforming solutions which are out of scope non-normative there are a number of well-known examples of solutions that seem to their users as though they are using a browser but because the client software communicates using proprietary protocols and techniques it is the combination of the client and the network component that is regarded as the http user agent. the communication between the client and the network component is therefore out of scope of this document. additionally where some kind of administrative arrangement exists between a transforming proxy and an origin server for the purposes of transforming content on the origin server s behalf this is also out of scope of this document. in both of the above cases it is good practice to adhere to the provisions of this document in respect of providing information about the device and the original ip address. k scope for future work non-normative k.1 powder the bpwg believes that powder will represent a powerful mechanism by which a server may express transformation preferences. future work in this area may recommend the use of powder to provide a mechanism for origin servers to indicate more precisely which alternatives they have and what transformation they are willing to allow on them and in addition to provide for content transformation proxies to indicate which services they are able to perform. k.2 link http header field the bpwg believes that the link http header field which was removed from http 1.1 and which is under discussion for reintroduction would represent a more general and flexible mechanism than use of the html link element as discussed in this recommendation. k.3 sources of device information the process of adapting content at the origin server or transforming it in a proxy is likely to have a dependency on a repository of device descriptions. an origin server s willingness to allow a transforming proxy to transform content may depend on its evaluation of the trustworthiness of device description data that is being used. there is scope for enhancement of the trust relationship by some means of indicating this. k.4 inter proxy communication there is scope for further work to define how multiple proxies may interoperate. a common case of multiple proxies is where a network provider transforming proxy and a search engine transforming proxy are both present. k.5 explicit consent robust mechanisms are needed for indicating consent to or prohibition of transformation operations of various kinds especially https link rewriting see 4.2.8.3 https link rewriting k.6 amendment to and refinement of http the bpwg believes that amendments to http are needed to improve the interoperability of transforming proxies. for example http does not provide a way to distinguish between prohibition of any kind of transformation and the prohibition only of restructuring and not recoding or compression at present http does not provide a mechanism for communicating original header field values. the scheme based on x-device prefixed fields described under 4.1.5 alteration of http header field values records and clarifies an approach used to achieve this effect by some content transformation proxies. this scheme relies upon non-standard http header fields which have been provisionally registered with iana. while the mechanism defined in that section based on current practice applies to conforming transformation proxy deployments it is possible that in future in collaboration with the ietf this approach will be reconsidered. this implies that the specified x-device prefixed fields may at some time become deprecated in favor of new equivalent fields or that an entirely different approach will be taken to representing such values. a number of mechanisms exist in http which might be exploited given more precise definition of their operation for example the options method and the http 300 multiple choices status. l acknowledgments non-normative the editor acknowledges contributions of various kinds from members of the mobile web best practices working group and earlier from the content transformation task force of that group. the editor acknowledges significant written contributions from fran ois daoust task force leader w3c magnus l nnroth ericsson and previously at drutt bryan sullivan at&t sean patterson novarra aaron kemp google rob finean openwave heiko gerlach vodafone martin jones volantis tom hume w3c invited expert eduardo casais w3c invited expert 