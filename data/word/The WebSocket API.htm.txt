the websocket api the websocket api w3c candidate recommendation 20 september 2012 this version http www.w3.org tr 2012 cr-websockets-20120920 latest published version http www.w3.org tr websockets latest editor s draft http dev.w3.org html5 websockets previous versions http www.w3.org tr 2012 wd-websockets-20120809 http www.w3.org tr 2012 wd-websockets-20120524 http www.w3.org tr 2011 cr-websockets-20111208 http www.w3.org tr 2011 wd-websockets-20110929 http www.w3.org tr 2011 wd-websockets-20110419 http www.w3.org tr 2009 wd-websockets-20090423 http www.w3.org tr 2009 wd-websockets-20091029 editor ian hickson google inc. copyright 2012 w3c mit ercim keio all rights reserved. w3c liability trademark and document use rules apply. the bulk of the text of this specification is also available in the whatwg web applications 1.0 specification under a license that permits reuse of the specification text. abstract this specification defines an api that enables web pages to use the websocket protocol defined by the ietf for two-way communication with a remote host. status of this document this section describes the status of this document at the time of its publication. other documents may supersede this document. a list of current w3c publications and the latest revision of this technical report can be found in the w3c technical reports index at http www.w3.org tr if you wish to make comments regarding this document in a manner that is tracked by the w3c please submit them via using our public bug database. if you do not have an account then you can enter feedback using this form feedback comments please enter your feedback carefully indicating the title of the section for which you are submitting feedback quoting the text that s wrong today if appropriate. if you re suggesting a new feature it s really important to say what the problem you re trying to solve is. that s more important than the solution in fact. please don t use section numbers as these tend to change rapidly and make your feedback harder to understand. note your ip address and user agent will be publicly recorded for spam prevention purposes. you can also e-mail feedback to public-webapps@w3.org subscribe archives or whatwg@whatwg.org subscribe archives all feedback is welcome. notifications of changes to this specification are sent along with notifications of changes to related specifications using the following mechanisms e-mail notifications of changes commit-watchers mailing list complete source diffs http lists.whatwg.org listinfo.cgi commit-watchers-whatwg.org browsable version-control record of all changes cvsweb interface with side-by-side diffs http dev.w3.org cvsweb html5 annotated summary with unified diffs http html5.org tools web-apps-tracker raw subversion interface svn checkout http svn.whatwg.org webapps the w3c web applications working group is the w3c working group responsible for this specification s progress along the w3c recommendation track. this specification is the 20 september 2012 candidate recommendation. comments and bugs submitted against the 09 august 2012 last call working draft are tracked in a comment tracking document. publication as a candidate recommendation does not imply endorsement by the w3c membership. this is a draft document and may be updated replaced or obsoleted by other documents at any time. it is inappropriate to cite this document as other than work in progress. this specification is being developed in conjunction with an rfc for a wire protocol the websocket protocol available from the following location rfc 6455 the websocket protocol http tools.ietf.org html rfc6455 this document was produced by a group operating under the 5 february 2004 w3c patent policy. w3c maintains a public list of any patent disclosures made in connection with the deliverables of the group that page also includes instructions for disclosing a patent. an individual who has actual knowledge of a patent which the individual believes contains essential claim s must disclose the information in accordance with section 6 of the w3c patent policy. candidate recommendation exit criteria to exit the candidate recommendation cr stage the following criteria must have been met there will be at least two interoperable implementations passing all approved test cases in the test suite for this specification. an implementation is to be available i.e. for download shipping i.e. not private and not experimental i.e. intended for a wide audience the working group will decide when the test suite is of sufficient quality to test interoperability and will produce an implementation report hosted together with the test suite a minimum of one month of the cr stage will have elapsed i.e. not until after 18 october 2012 this is to ensure that enough time is given for any remaining major errors to be caught. the cr period will be extended if implementations are slow to appear. table of contents 1 introduction 2 conformance requirements 2.1 dependencies 3 terminology 4 the websocket interface 5 feedback from the protocol 6 ping and pong frames 7 parsing websocket urls 8 event definitions 9 garbage collection references acknowledgements 1 introduction this section is non-normative. to enable web applications to maintain bidirectional communications with server-side processes this specification introduces the websocket interface. this interface does not allow for raw access to the underlying network. for example this interface could not be used to implement an irc client without proxying messages through a custom server. 2 conformance requirements all diagrams examples and notes in this specification are non-normative as are all sections explicitly marked non-normative. everything else in this specification is normative. the key words must must not required should should not recommended may and optional in the normative parts of this document are to be interpreted as described in rfc2119. for readability these words do not appear in all uppercase letters in this specification. rfc2119 requirements phrased in the imperative as part of algorithms such as strip any leading space characters or return false and abort these steps are to be interpreted with the meaning of the key word must should may etc used in introducing the algorithm. some conformance requirements are phrased as requirements on attributes methods or objects. such requirements are to be interpreted as requirements on user agents. conformance requirements phrased as algorithms or specific steps may be implemented in any manner so long as the end result is equivalent. in particular the algorithms defined in this specification are intended to be easy to follow and not intended to be performant. the only conformance class defined by this specification is user agents. user agents may impose implementation-specific limits on otherwise unconstrained inputs e.g. to prevent denial of service attacks to guard against running out of memory or to work around platform-specific limitations. when support for a feature is disabled e.g. as an emergency measure to mitigate a security problem or to aid in development or for performance reasons user agents must act as if they had no support for the feature whatsoever and as if the feature was not mentioned in this specification. for example if a particular feature is accessed via an attribute in a web idl interface the attribute itself would be omitted from the objects that implement that interface leaving the attribute on the object but making it return null or throw an exception is insufficient. 2.1 dependencies this specification relies on several other underlying specifications. html many fundamental concepts from html are used by this specification. html webidl the idl blocks in this specification use the semantics of the webidl specification. webidl 3 terminology the construction a foo object where foo is actually an interface is sometimes used instead of the more accurate an object implementing the interface foo the term dom is used to refer to the api set made available to scripts in web applications and does not necessarily imply the existence of an actual document object or of any other node objects as defined in the dom core specifications. domcore an idl attribute is said to be getting when its value is being retrieved e.g. by author script and is said to be setting when a new value is assigned to it. 4 the websocket interface constructor domstring url optional domstring or domstring protocols interface websocket eventtarget readonly attribute domstring url ready state const unsigned short connecting 0 const unsigned short open 1 const unsigned short closing 2 const unsigned short closed 3 readonly attribute unsigned short readystate readonly attribute unsigned long bufferedamount networking attribute eventhandler onopen attribute eventhandler onerror attribute eventhandler onclose readonly attribute domstring extensions readonly attribute domstring protocol void close clamp optional unsigned short code optional domstring reason messaging attribute eventhandler onmessage attribute domstring binarytype void send domstring data void send blob data void send arraybuffer data void send arraybufferview data the websocket url protocols constructor takes one or two arguments. the first argument url specifies the url to which to connect. the second protocols if present is either a string or an array of strings. if it is a string it is equivalent to an array consisting of just that string if it is omitted it is equivalent to the empty array. each string in the array is a subprotocol name. the connection will only be established if the server reports that it has selected one of these subprotocols. the subprotocol names must all be strings that match the requirements for elements that comprise the value of sec-websocket-protocol header fields as defined by the websocket protocol specification. wsp when the websocket constructor is invoked the ua must run these steps parse a websocket url s components from the url argument to obtain host port resource name and secure. if this fails throw a syntaxerror exception and abort these steps. wsp if secure is false but the origin of the entry script has a scheme component that is itself a secure protocol e.g. https then throw a securityerror exception. if port is a port to which the user agent is configured to block access then throw a securityerror exception. user agents typically block access to well-known ports like smtp. access to ports 80 and 443 should not be blocked including the unlikely cases when secure is false but port is 443 or secure is true but port is 80. if protocols is absent let protocols be an empty array. otherwise if protocols is present and a string let protocols instead be an array consisting of just that string. if any of the values in protocols occur more than once or otherwise fail to match the requirements for elements that comprise the value of sec-websocket-protocol header fields as defined by the websocket protocol specification then throw a syntaxerror exception and abort these steps. wsp let origin be the ascii serialization of the origin of the entry script converted to ascii lowercase. return a new websocket object and continue these steps in the background without blocking scripts establish a websocket connection given the set host port resource name secure along with the protocols list an empty list for the extensions and origin. the headers to send appropriate cookies must be a cookie header whose value is the cookie-string computed from the user s cookie store and the url url for these purposes this is not a non-http api. wsp cookies when the user agent validates the server s response during the establish a websocket connection algorithm if the status code received from the server is not 101 e.g. it is a redirect the user agent must fail the websocket connection. following http procedures here could introduce serious security problems in a web browser context. for example consider a host with a websocket server at one path and an open http redirector at another. suddenly any script that can be given a particular websocket url can be tricked into communicating to and potentially sharing secrets with any host on the internet even if the script checks that the url has the right hostname. if the establish a websocket connection algorithm fails it triggers the fail the websocket connection algorithm which then invokes the close the websocket connection algorithm which then establishes that the websocket connection is closed which fires the close event as described below. this constructor must be visible when the script s global object is either a window object or an object implementing the workerutils interface. the url attribute must return the result of resolving the url that was passed to the constructor. it doesn t matter what it is resolved relative to since we already know it is an absolute url. the readystate attribute represents the state of the connection. it can have the following values connecting numeric value 0 the connection has not yet been established. open numeric value 1 the websocket connection is established and communication is possible. closing numeric value 2 the connection is going through the closing handshake or the close method has been invoked. closed numeric value 3 the connection has been closed or could not be opened. when the object is created its readystate must be set to connecting 0 the extensions attribute must initially return the empty string. after the websocket connection is established its value might change as defined below. the extensions attribute returns the extensions selected by the server if any. currently this will only ever be the empty string. the protocol attribute must initially return the empty string. after the websocket connection is established its value might change as defined below. the protocol attribute returns the subprotocol selected by the server if any. it can be used in conjunction with the array form of the constructor s second argument to perform subprotocol negotiation. the close method must run the following steps if the method s first argument is present but is not an integer equal to 1000 or in the range 3000 to 4999 throw an invalidaccesserror exception and abort these steps. if the method s second argument is present then run these substeps let raw reason be the method s second argument. let unicode reason be the result of converting raw reason to a sequence of unicode characters. let reason be the result of encoding unicode reason as utf-8. if reason is longer than 123 bytes then throw a syntaxerror exception and abort these steps. rfc3629 run the first matching steps from the following list if the readystate attribute is in the closing 2 or closed 3 state do nothing. the connection is already closing or is already closed. if it has not already a close event will eventually fire as described below. if the websocket connection is not yet established wsp fail the websocket connection and set the readystate attribute s value to closing 2 wsp the fail the websocket connection algorithm invokes the close the websocket connection algorithm which then establishes that the websocket connection is closed which fires the close event as described below. if the websocket closing handshake has not yet been started wsp start the websocket closing handshake and set the readystate attribute s value to closing 2 wsp if the first argument is present then the status code to use in the websocket close message must be the integer given by the first argument. wsp if the second argument is also present then reason must be provided in the close message after the status code. rfc3629 wsp the start the websocket closing handshake algorithm eventually invokes the close the websocket connection algorithm which then establishes that the websocket connection is closed which fires the close event as described below. otherwise set the readystate attribute s value to closing 2 the websocket closing handshake is started and will eventually invoke the close the websocket connection algorithm which will establish that the websocket connection is closed and thus the close event will fire as described below. the bufferedamount attribute must return the number of bytes of application data utf-8 text and binary data that have been queued using send but that as of the last time the event loop started executing a task had not yet been transmitted to the network. this thus includes any text sent during the execution of the current task regardless of whether the user agent is able to transmit text asynchronously with script execution. this does not include framing overhead incurred by the protocol or buffering done by the operating system or network hardware. if the connection is closed this attribute s value will only increase with each call to the send method the number does not reset to zero once the connection closes in this simple example the bufferedamount attribute is used to ensure that updates are sent either at the rate of one update every 50ms if the network can handle that rate or at whatever rate the network can handle if that is too fast. var socket new websocket ws game.example.com 12010 updates socket.onopen function setinterval function if socket.bufferedamount 0 socket.send getupdatedata 50 the bufferedamount attribute can also be used to saturate the network without sending the data at a higher rate than the network can handle though this requires more careful monitoring of the value of the attribute over time. when a websocket object is created its binarytype idl attribute must be set to the string blob on getting it must return the last value it was set to. on setting if the new value is either the string blob or the string arraybuffer then set the idl attribute to this new value. otherwise throw a syntaxerror exception. this attribute allows authors to control how binary data is exposed to scripts. by setting the attribute to blob binary data is returned in blob form by setting it to arraybuffer it is returned in arraybuffer form. user agents can use this as a hint for how to handle incoming binary data if the attribute is set to blob it is safe to spool it to disk and if it is set to arraybuffer it is likely more efficient to keep the data in memory. naturally user agents are encouraged to use more subtle heuristics to decide whether to keep incoming data in memory or not e.g. based on how big the data is or how common it is for a script to change the attribute at the last minute. this latter aspect is important in particular because it is quite possible for the attribute to be changed after the user agent has received the data but before the user agent has fired the event for it. the send data method transmits data using the connection. if the readystate attribute is connecting it must throw an invalidstateerror exception. otherwise the user agent must run the appropriate set of steps from the following list if the argument is a string let data be the result of converting the data argument to a sequence of unicode characters. if the websocket connection is established and the websocket closing handshake has not yet started then the user agent must send a websocket message comprised of data using a text frame opcode if the data cannot be sent e.g. because it would need to be buffered but the buffer is full the user agent must close the websocket connection with prejudice. any invocation of this method with a string argument that does not throw an exception must increase the bufferedamount attribute by the number of bytes needed to express the argument as utf-8. unicode rfc3629 wsp if the argument is a blob object if the websocket connection is established and the websocket closing handshake has not yet started then the user agent must send a websocket message comprised of data using a binary frame opcode if the data cannot be sent e.g. because it would need to be buffered but the buffer is full the user agent must close the websocket connection with prejudice. the data to be sent is the raw data represented by the blob object. any invocation of this method with a blob argument that does not throw an exception must increase the bufferedamount attribute by the size of the blob object s raw data in bytes. wsp fileapi if the argument is an arraybuffer object if the websocket connection is established and the websocket closing handshake has not yet started then the user agent must send a websocket message comprised of data using a binary frame opcode if the data cannot be sent e.g. because it would need to be buffered but the buffer is full the user agent must close the websocket connection with prejudice. the data to be sent is the data stored in the buffer described by the arraybuffer object. any invocation of this method with an arraybuffer argument that does not throw an exception must increase the bufferedamount attribute by the length of the arraybuffer in bytes. wsp typedarray if the argument is an arraybufferview object if the websocket connection is established and the websocket closing handshake has not yet started then the user agent must send a websocket message comprised of data using a binary frame opcode if the data cannot be sent e.g. because it would need to be buffered but the buffer is full the user agent must close the websocket connection with prejudice. the data to be sent is the data stored in the section of the buffer described by the arraybuffer object that the arraybufferview object references. any invocation of this method with an arraybufferview argument that does not throw an exception must increase the bufferedamount attribute by the length of the arraybufferview in bytes. wsp typedarray the following are the event handlers and their corresponding event handler event types that must be supported as idl attributes by all objects implementing the websocket interface event handler event handler event type onopen open onmessage message onerror error onclose close 5 feedback from the protocol when the websocket connection is established the user agent must queue a task to run these steps change the readystate attribute s value to open 1 change the extensions attribute s value to the extensions in use if is not the null value. wsp change the protocol attribute s value to the subprotocol in use if is not the null value. wsp act as if the user agent had received a set-cookie-string consisting of the cookies set during the server s opening handshake for the url url given to the websocket constructor. cookies rfc3629 wsp fire a simple event named open at the websocket object. when a websocket message has been received with type type and data data the user agent must queue a task to follow these steps wsp if the readystate attribute s value is not open 1 then abort these steps. let event be an event that uses the messageevent interface with the event type message which does not bubble is not cancelable and has no default action. html initialize event s origin attribute to the unicode serialization of the origin of the url that was passed to the websocket object s constructor. if type indicates that the data is text then initialize event s data attribute to data. if type indicates that the data is binary and binarytype is set to blob then initialize event s data attribute to a new blob object that represents data as its raw data. fileapi if type indicates that the data is binary and binarytype is set to arraybuffer then initialize event s data attribute to a new read-only arraybuffer object whose contents are data. typedarray dispatch event at the websocket object. user agents are encouraged to check if they can perform the above steps efficiently before they run the task picking tasks from other task queues while they prepare the buffers if not. for example if the binarytype attribute was set to blob when the data arrived and the user agent spooled all the data to disk but just before running the above task for this particular message the script switched binarytype to arraybuffer the user agent would want to page the data back to ram before running this task so as to avoid stalling the main thread while it created the arraybuffer object. here is an example of how to define a handler for the message event in the case of text frames mysocket.onmessage function event if event.data on turnlampon else if event.data off turnlampoff the protocol here is a trivial one with the server just sending on or off messages. when the websocket closing handshake is started the user agent must queue a task to change the readystate attribute s value to closing 2 if the close method was called the readystate attribute s value will already be set to closing 2 when this task runs. wsp when the websocket connection is closed possibly cleanly the user agent must queue a task to run the following substeps change the readystate attribute s value to closed 3 if the user agent was required to fail the websocket connection or the websocket connection is closed with prejudice fire a simple event named error at the websocket object. wsp create an event that uses the closeevent interface with the event type close which does not bubble is not cancelable has no default action whose wasclean attribute is initialized to true if the connection closed cleanly and false otherwise whose code attribute is initialized to the websocket connection close code and whose reason attribute is initialized to the websocket connection close reason decoded as utf-8 with error handling and dispatch the event at the websocket object. wsp user agents must not convey any failure information to scripts in a way that would allow a script to distinguish the following situations a server whose host name could not be resolved. a server to which packets could not successfully be routed. a server that refused the connection on the specified port. a server that failed to correctly perform a tls handshake e.g. the server certificate can t be verified a server that did not complete the opening handshake e.g. because it was not a websocket server a websocket server that sent a correct opening handshake but that specified options that caused the client to drop the connection e.g. the server specified a subprotocol that the client did not offer a websocket server that abruptly closed the connection after successfully completing the opening handshake. in all of these cases the the websocket connection close code would be 1006 as required by the websocket protocol specification. wsp allowing a script to distinguish these cases would allow a script to probe the user s local network in preparation for an attack. in particular this means the code 1015 is not used by the user agent unless the server erroneously uses it in its close frame of course the task source for all tasks queued in this section is the websocket task source. 6 ping and pong frames the websocket protocol specification defines ping and pong frames that can be used for keep-alive heart-beats network status probing latency instrumentation and so forth. these are not currently exposed in the api. user agents may send ping and unsolicited pong frames as desired for example in an attempt to maintain local network nat mappings to detect failed connections or to display latency metrics to the user. user agents must not use pings or unsolicited pongs to aid the server it is assumed that servers will solicit pongs whenever appropriate for the server s needs. 7 parsing websocket urls the steps to parse a websocket url s components from a string url are as follows. these steps return either a host a port a resource name and a secure flag or they fail. if the url string is not an absolute url then fail this algorithm. resolve the url string with the url character encoding set to utf-8. rfc3629 it doesn t matter what it is resolved relative to since we already know it is an absolute url at this point. if url does not have a scheme component whose value when converted to ascii lowercase is either ws or wss then fail this algorithm. if url has a fragment component then fail this algorithm. if the scheme component of url is ws set secure to false otherwise the scheme component is wss set secure to true. let host be the value of the host component of url converted to ascii lowercase. if url has a port component then let port be that component s value otherwise there is no explicit port. if there is no explicit port then if secure is false let port be 80 otherwise let port be 443. let resource name be the value of the path component which might be empty of url. if resource name is the empty string set it to a single character u+002f solidus if url has a query component then append a single u+003f question mark character to resource name followed by the value of the query component. return host port resource name and secure. 8 event definitions constructor domstring type optional closeeventinit eventinitdict interface closeevent event readonly attribute boolean wasclean readonly attribute unsigned short code readonly attribute domstring reason dictionary closeeventinit eventinit boolean wasclean unsigned short code domstring reason the wasclean attribute must return the value it was initialized to. when the object is created this attribute must be initialized to false. it represents whether the connection closed cleanly or not. the code attribute must return the value it was initialized to. when the object is created this attribute must be initialized to zero. it represents the websocket connection close code provided by the server. the reason attribute must return the value it was initialized to. when the object is created this attribute must be initialized to empty string. it represents the websocket connection close reason provided by the server. 9 garbage collection a websocket object whose readystate attribute s value was set to connecting 0 as of the last time the event loop started executing a task must not be garbage collected if there are any event listeners registered for open events message events error events or close events. a websocket object whose readystate attribute s value was set to open 1 as of the last time the event loop started executing a task must not be garbage collected if there are any event listeners registered for message events error or close events. a websocket object whose readystate attribute s value was set to closing 2 as of the last time the event loop started executing a task must not be garbage collected if there are any event listeners registered for error or close events. a websocket object with an established connection that has data queued to be transmitted to the network must not be garbage collected. wsp if a websocket object is garbage collected while its connection is still open the user agent must start the websocket closing handshake with no status code for the close message. wsp if a user agent is to make disappear a websocket object this happens when a document object goes away the user agent must follow the first appropriate set of steps from the following list if the websocket connection is not yet established wsp fail the websocket connection. wsp if the websocket closing handshake has not yet been started wsp start the websocket closing handshake with the status code to use in the websocket close message being 1001. wsp otherwise do nothing. references all references are normative unless marked non-normative cookies http state management mechanism a. barth. ietf. domcore dom4 a. van kesteren. w3c. fileapi file api a. ranganathan. w3c. html html5 i. hickson. w3c. rfc2119 key words for use in rfcs to indicate requirement levels s. bradner. ietf. rfc3629 utf-8 a transformation format of iso 10646 f. yergeau. ietf. typedarray typed array specification d. herman k. russell. khronos. unicode the unicode standard. unicode consortium. webidl web idl c. mccormack. w3c. wsp the websocket protocol i. fette a. melnikov. ietf. acknowledgements for a full list of acknowledgements please see the html specification. html 